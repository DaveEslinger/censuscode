"0",""
"0","# Download and data process (loop through all variables)"
"0","# Declare test variables outside of loop"
"0","# Data available for annual by area begins in 1990- Present"
"0",""
"0","years=1990:2020"
"0",""
"0","vars_naic <- c(""annual_avg_estabs_count"",""annual_avg_emplvl"",""total_annual_wages"",""avg_annual_pay"")"
"0",""
"0","# Define extra variables needed"
"0","extra_naic_vars <- c(""area_fips"", ""year"",""agglvl_code"", ""own_title"","
"0","                    ""industry_title"")"
"0",""
"0","outfile_base <- here(""data"",""naics_extracted"")"
"0",""
"0","# Calculate the maximum iterations"
"0",""
"0","max_iterations <-length (years)* length (fips)* length (vars_naic)"
"0",""
"0","# Initialize a variable to count total iterations"
"0",""
"0","total_iterations <- 0"
"0",""
"0","# Start the loop"
"0",""
"0","test_years <- c(1995) # years 1990:2020"
"0","test_fips <- fips #[1:452]"
"0",""
"0","for (this_year in test_years) {"
"0","  tic(""Year loop"")"
"0","  print(paste(""'Outer' loop with year ="", this_year))"
"0","  outfile <- paste0(outfile_base, ""_"", this_year,"".csv"")"
"0","  # write out a header row"
"0","  write_lines(paste(c(extra_naic_vars, vars_naic), collapse = "",""), outfile,   append = FALSE)"
"0","  naic_filename <- paste0(naic_prefix, this_year, naic_body)"
"0","  naic_URL <-"
"0","    paste0(base_URL,"
"0","           this_year,"
"0","           naic_subdirs,"
"0","           naic_filename,"
"0","           naic_extension)"
"0","  naic_local <- here(""data"", paste0(naic_filename, naic_extension))"
"0","  print(naic_URL)"
"0","  if (! file.exists(naic_local)) {"
"0","    tic(""Download"")"
"0","    download.file(naic_URL, naic_local)"
"0","    toc() # Download"
"0","  }"
"0","  file_list <- unzip(naic_local, list = TRUE)"
"0","  "
"0","  for (this_fips in test_fips){"
"0","    tic(""Fips loop"")"
"0","    print(paste(""'Middle' loop with FIPS ="",this_fips))"
"0","    download_list <- file_list %>%"
"0","      filter(grepl(this_fips, Name))"
"0","    "
"0","    if(length(download_list$Name) == 0) {"
"0","      print(paste0(""No data for FIPS = "", this_fips))"
"0","      toc() #FIPS w/out data"
"0","    } else {"
"0","      "
"0","      nfile <- unzip("
"0","        naic_local,"
"0","        files = (download_list$Name),"
"0","        junkpaths = TRUE,"
"0","        overwrite = TRUE,"
"0","        exdir = here(""data"", ""tmp"")"
"0","      ) "
"0","      fips_df_naic <- read_csv(nfile)"
"0","      glimpse(fips_df_naic)"
"0","      "
"0","      # This next bit subsets out the data needed and keeps both the overall "
"0","      # county sum and the sums by each major industry level (Federal, State,       and Private.  The last three SHOULD sum up to the countywide total"
"0","      # that doesn't seem to be the case all the time."
"0","      # Note that using subset() keeps you from having to do a third nested loop."
"0","     "
"0","      fips_vars <- subset(fips_df_naic, select = c(extra_naic_vars,  vars_naic)) %>% "
"0","        filter(agglvl_code == 70 | agglvl_code == 71)  # %>% "
"0","      # These are the codes used on summary records produced by the Quarterly Census of Employment and Wages (QCEW) program to indicate the aggregation level of the data summarized on the record. These aggregation level codes are for QCEW records coded to the North American Industry Classification System (NAICS)"
"0","      # group_by(agglvl_code) %>% "
"0","      # mutate(across(c(annual_avg_estabs_count:avg_annual_pay), sum))"
"0","      # "
"0","      # "
"0","      # The last 2 lines above would have summed the 3 sectors into a total"
"0","      # to compare with the countywide total.  I suggest doing that  "
"0","      # in another program once this one has extracted everything.  "
"0","      "
"0","      # Append the info for this FIPS onto the output file."
"0","      write_csv(fips_vars, outfile, append = TRUE)"
"0","      "
"0","      # Remove the unzipped file for this FIPS"
"0","      unlink(nfile, force = TRUE) "
"0","      toc() # FIPS loops"
"0","    "
"0","    }"
"0","  }"
"0","  "
"0","  # Done with year, remove zip file for this year"
"0","  unlink(naic_local, force = TRUE) "
"0","  toc() # Year loop"
"0","}    "
"1","[1]"
"1"," ""'Outer' loop with year = 1995"""
"1","
"
"1","[1]"
"1"," ""https://data.bls.gov/cew/data/files/1995/csv/1995_annual_by_area.zip"""
"1","
"
"2","trying URL 'https://data.bls.gov/cew/data/files/1995/csv/1995_annual_by_area.zip'
"
"2","Content type 'application/zip'"
"2"," length 49699848 bytes (47.4 MB)
"
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","="
"2","
"
"2","downloaded 32.3 MB

"
"2","Warning in download.file(naic_URL, naic_local) :"
"2","
 "
"2"," downloaded length 33889102 != reported length 49699848
"
"2","Warning in download.file(naic_URL, naic_local) :"
"2","
 "
"2"," URL 'https://data.bls.gov/cew/data/files/1995/csv/1995_annual_by_area.zip': Timeout of 60 seconds was reached
"
"2","Error in download.file(naic_URL, naic_local) : 
  download from 'https://data.bls.gov/cew/data/files/1995/csv/1995_annual_by_area.zip' failed
"
